apiVersion: v1
kind: ServiceAccount
metadata:
  name: "headscale-{{ include "k3s-server.fullname" . }}"
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "k3s-server.fullname" . }}-secret-manager
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "k3s-server.fullname" . }}-secret-manager-binding
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "k3s-server.fullname" . }}-secret-manager
subjects:
  - kind: ServiceAccount
    name: "headscale-{{ include "k3s-server.fullname" . }}"
    namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "k3s-server.fullname" . }}-post-start-job"
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": "post-install"
    "helm.sh/hook-delete-policy": "before-hook-creation"
spec:
  template:
    metadata:
      labels:
        {{- include "k3s-server.labels" . | nindent 8 }}
    spec:
      containers:
        - name: download-config
          image: alpine:latest
          command: ["sh", "-c"]
          args:
            - |
              mkdir -p /etc/headscale
              wget -O /etc/headscale/config.yaml https://raw.githubusercontent.com/juanfont/headscale/main/config-example.yaml
          volumeMounts:
            - name: config-storage
              mountPath: /etc/headscale
        - name: generate-key
          image: headscale/headscale:stable
          args:
            - generate private-key > /tmp/noise_private.key
          volumeMounts:
            - name: tmp-storage
              mountPath: /tmp
        - name: create-secret
          image: bitnami/kubectl:latest
          command: ["sh", "-c"]
          args:
            - |
              kubectl create -n {{ .Release.Namespace }} secret generic "headscale-{{ include "k3s-server.fullname" . }}" --from-file=noise_private.key=/tmp/noise_private.key --from-file=config.yaml=/etc/headscale/config.yaml
          volumeMounts:
            - name: config-storage
              mountPath: /etc/headscale
            - name: tmp-storage
              mountPath: /tmp
      volumes:
        - name: config-storage
          emptyDir: {}
        - name: tmp-storage
          emptyDir: {}
      restartPolicy: OnFailure
      serviceAccount: "headscale-{{ include "k3s-server.fullname" . }}"
      serviceAccountName: "headscale-{{ include "k3s-server.fullname" . }}"