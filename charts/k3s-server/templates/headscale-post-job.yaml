apiVersion: v1
kind: ServiceAccount
metadata:
  name: "headscale-{{ include "k3s-server.fullname" . }}"
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "k3s-server.fullname" . }}-secret-manager
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "k3s-server.fullname" . }}-secret-manager-binding
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "k3s-server.fullname" . }}-secret-manager
subjects:
  - kind: ServiceAccount
    name: "headscale-{{ include "k3s-server.fullname" . }}"
    namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "k3s-server.fullname" . }}-post-start-job"
  labels:
    {{- include "k3s-server.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": "post-install"
    "helm.sh/hook-delete-policy": "before-hook-creation"
spec:
  ttlSecondsAfterFinished: 0
  template:
    metadata:
      labels:
        {{- include "k3s-server.labels" . | nindent 8 }}
    spec:
      containers:
        - name: generate-key
          image: headscale/headscale:stable-debug
          command: ["sh", "-c"]
          args:
            - |-
              headscale generate private-key > /tmp/noise_private.key
          volumeMounts:
            - name: tmp-storage
              mountPath: /tmp
            - name: headscale-configs
              mountPath: /etc/headscale
        - name: create-secret
          image: bitnami/kubectl:latest
          command: ["sh", "-c"]
          args:
            - |
              kubectl create -n {{ .Release.Namespace }} secret generic "headscale-{{ include "k3s-server.fullname" . }}" --from-file=noise_private.key=/tmp/noise_private.key --dry-run=client -o yaml | kubectl apply -f -
          volumeMounts:
            - name: headscale-configs
              mountPath: /etc/headscale
            - name: tmp-storage
              mountPath: /tmp
        - name: create-database
          image: postgres:alpine
          command: ["sh", "-c"]
          args:
            - |
              export DSN=postgres://{{ $.Values.hs.k3s.username }}:{{ $.Values.hs.k3s.password }}@{{ $.Values.hs.k3s.hostname }}:{{ $.Values.hs.k3s.port }}?sslmode=disable
              psql $DSN -c "CREATE DATABASE IF EXISTS {{ include "k3s-server.sanitizeNameHeadscale" . }};"
      volumes:
        - name: tmp-storage
          emptyDir: {}
        - name: headscale-configs
          configMap:
            name: "headscale-{{ include "k3s-server.fullname" . }}"
        - name: headscale-configs-source
          secret:
            secretName: "headscale-{{ include "k3s-server.fullname" . }}"
      restartPolicy: OnFailure
      serviceAccount: "headscale-{{ include "k3s-server.fullname" . }}"
      serviceAccountName: "headscale-{{ include "k3s-server.fullname" . }}"